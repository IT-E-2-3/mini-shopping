<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team3.shopping.dao.OrderDao">
	<select id="getMyCartByMlogin" resultType="OrderRowDetail" parameterType="String">
		 select mycart.mid, mycart.color_code, mycart.size_code, 
		 color_url.product_detail_url1, product.pbrand, 
		product.pname, product.pprice , mycart.camount as oamount
		from (mycart join product on mycart.pid = product.pid ) join color_url on mycart.pid = color_url.pid and mycart.color_code= color_url.color_code
     	where mid =#{mid}
     	order by mycart.pid
	</select>

	<select id="getPriceByCartPid" resultType="cart" parameterType="cart">
		SELECT price
		FROM product
		where mid = #{cart.pid}
	</select>
	
	<select id="getMidBymolgin" parameterType="String" resultType="String">
		SELECT mid FROM member where mlogin_id =#{mlogin_id}
	</select>
	
	<select id="selectStockByPidColor" parameterType="OrderRowDetail" resultType="int">
		SELECT REMAINING_STOCK
		FROM stock
		WHERE pid=(SELECT pid FROM color_url where product_detail_url1=#{product_detail_url1}) and color_code=#{color_code} and size_code=#{size_code}
	</select>
	
	<select id="selectAmountByPidColor" parameterType="OrderRowDetail" resultType="int">
		SELECT camount
		FROM mycart
		WHERE mid=#{mid} and pid=(SELECT pid FROM color_url where product_detail_url1=#{product_detail_url1}) and color_code=#{color_code} and size_code=#{size_code}
	</select>
	
	<update id="updateStock" >
		UPDATE stock
		SET REMAINING_STOCK =#{stock_after}
		WHERE pid=(SELECT pid FROM color_url where product_detail_url1=#{obj.product_detail_url1}) and color_code=#{obj.color_code} and size_code=#{obj.size_code}
	</update>
	
	<delete id="DeleteProductFromCart" parameterType="OrderRowDetail">
		DELETE FROM mycart
		WHERE mid=#{mid} and pid=(SELECT pid FROM color_url where product_detail_url1=#{product_detail_url1}) and color_code=#{color_code} and size_code=#{size_code}
	</delete>
	
	<insert id="intertOrderItems">
	INSERT INTO order_items
	(oid, pid, color_code, size_code, oamount)
	VALUES (#{oid},(SELECT pid FROM color_url where product_detail_url1=#{obj.product_detail_url1}), #{obj.color_code},#{obj.size_code}, #{obj.oamount})
	</insert>
	
	<insert id="insertOrderByForm" parameterType="order" >
	INSERT INTO orders
	(oid, mid, odate, 
	ozip_code, oaddress,odetail_address,
	 orecipient, orecipient_tel,ototal_price,
	  ochannel,  ocard_name, ocard_installmentrate, 
	  ocard_installment_period, oaccountholder, odeposit_deadline,
	  order_tel, oaddtional_tel, orequest, 
	  orecipient_email , opayment)
	VALUES (#{oid}, #{mid}, CURRENT_TIMESTAMP,
	 #{ozip_code}, #{oaddress}, #{odetail_address}, 
	 #{orecipent}, #{orecipent_tel}, #{ototal_price}, 
	 #{ochannel}, #{ocard_name, jdbcType=VARCHAR}, #{ocard_installmentrate, jdbcType=VARCHAR}, 
	 #{ocard_installmentrate_period, jdbcType=VARCHAR}, #{oaccountholder, jdbcType=VARCHAR}, #{odeposit_deadline, jdbcType=VARCHAR}, 
	 #{order_tel}, #{oaddtional_tel}, #{orequest}, 
	 #{orecipent_email, jdbcType=VARCHAR}, #{opayment, jdbcType=VARCHAR})
	
	</insert>
</mapper>